# Research: RESTful 宪法符合性审计与整改

**Feature**: 002-restful-api-compliance  
**Phase**: 0（研究与决策）

## 1. 审计执行方式

**Decision**: 首轮审计采用「人工 + 结构化清单」为主，辅以从代码/注解中提取接口列表的脚本（如扫描 `@RequestMapping` / `@GetMapping` 等），产出固定格式的审计报告（见 data-model）；不强制引入第三方 REST 静态分析库，以降低依赖与误报。

**Rationale**: 原则 6 的判定（如 URL 是否名词化、分页是否用 page/size）部分依赖语义，纯静态规则易误报；先用手工可维护的清单与脚本保证结果可信，后续若有需要再考虑引入 ArchUnit、OpenAPI 校验等。

**Alternatives considered**:
- 纯人工逐接口填表：可操作但易遗漏，且难以复现；不采纳。
- 引入商业/开源 REST 规范检查器：增加依赖与学习成本，且与当前宪法条文未必一一对应；可后续迭代评估。
- 完全依赖 OpenAPI 导出 + 校验：需先统一生成 OpenAPI，且宪法规则需映射到 OpenAPI 规则；可作为 Phase 1 之后的增强。

---

## 2. 持续验证机制

**Decision**: 在首轮审计与整改完成后，建立「原则 6 检查清单」文档（含 URL 名词化、HTTP 方法、分页/排序、Result 包装等子项），在代码评审（MR）时强制核对；可选：在 CI 中增加轻量脚本，扫描新增/修改的 Controller 方法，检查路径中是否包含常见动词（如 get、create、delete、list 等）或非标准分页参数，失败时仅告警或阻塞 MR 由团队约定。

**Rationale**: 清单可复用且不依赖新工具链；CI 脚本可逐步细化规则，避免一次性上过严规则导致误拦。

**Alternatives considered**:
- 仅文档清单、无 CI：依赖人工记忆，易遗漏；不采纳为唯一手段。
- 严格 CI 门禁（任一项不通过即失败）：规则未稳定前易误报；采纳为“可选 + 可配置”，先告警后门禁。

---

## 3. 例外与兼容策略

**Decision**:
- **认证相关路径**（如 `/auth/login`、`/auth/logout`、`/auth/refresh`、`/auth/captcha`）：在审计报告中标注为「原则 6 例外」，在 API 文档中说明“沿用业界惯例的 RPC 风格，其余接口严格 RESTful”；不强制改为名词资源路径。
- **破坏性变更**：若某接口整改会导致前端/调用方不兼容，采用「URL 版本化」（如 `/api/v2/...`）或保留旧路径一段时间并做兼容层，在审计报告中标明「计划整改」与时间窗口；不未通知就下线旧路径。
- **Gateway/第三方代理接口**：若审计范围包含经 Gateway 转发的第三方或遗留接口，其不符合项仅记录在报告中，是否整改由业务方决定；本特性不强制修改非本仓库维护的接口。

**Rationale**: 平衡规范统一与落地成本，避免因过度整改导致上线风险；例外透明可查，便于后续收紧。

**Alternatives considered**:
- 认证也改为 RESTful（如 `POST /auth/sessions` 表示登录）：语义更统一但改动面大，且与常见前端/网关约定不一致；暂不采纳，仅文档化例外。
- 一律不设例外：部分场景（如登录）业界普遍用动词路径，硬改不利于协作；采纳有限例外并记录。

---

## 4. 审计报告与规则可操作化

**Decision**: 将宪法 115–133 条（原则 6）拆解为可逐条勾选/判定的检查项，例如：
- C1: HTTP 方法属于 {GET, POST, PUT, DELETE, PATCH}
- C2: URL 路径为名词（复数）且不含动词
- C3: 响应为 JSON 且使用 Result&lt;T&gt; 包装
- C4: 分页使用 page、size 参数，排序使用 sort 参数（或文档化例外）
- C5: 版本控制通过 URL 路径（如 /api/v1/...）或文档说明当前策略
- C6: 文档中标注 HTTP 方法与主要状态码

审计报告结构：按「接口」为行、「检查项」为列，每格为通过/不通过/例外；不通过须附原因与建议改法（见 data-model.md）。

**Rationale**: 便于人工与后续自动化逐项执行，且与宪法条文一一对应，复检与追溯清晰。

**Alternatives considered**:
- 仅“通过/不通过”不分子项：不利于定位与整改；不采纳。
- 子项过细（如按每个 HTTP 状态码拆）：增加维护成本；采纳上述折中粒度。
