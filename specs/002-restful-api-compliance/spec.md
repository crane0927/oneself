# Feature Specification: 现有接口 RESTful 宪法符合性检查与整改

**Feature Branch**: `002-restful-api-compliance`  
**Created**: 2026-02-06  
**Status**: Draft  
**Input**: User description: "检查现有接口，是否符合宪法 @.specify/memory/constitution.md:115-133"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 生成接口符合性审计报告 (Priority: P1)

项目负责人或架构师需要对当前所有对外 HTTP 接口做一次全面审计，对照《宪法》原则 6（RESTful API 设计）逐条检查，并得到一份可读的审计报告。报告需列出每个接口、对应检查项、是否符合、以及不符合时的具体问题与建议改法。

**Why this priority**: 无审计结果则无法判断整改范围与优先级，是后续所有工作的前提。

**Independent Test**: 执行审计流程后能交付一份完整报告，报告覆盖所有现有接口且每条规则均有明确通过/不通过结论。

**Acceptance Scenarios**:

1. **Given** 存在多个服务的 HTTP 接口定义，**When** 执行宪法符合性审计，**Then** 产出报告列出每个接口的 URL、HTTP 方法、以及针对「原则 6」各子项的符合情况。
2. **Given** 某接口 URL 包含动词（如 `/getUser`），**When** 审计执行，**Then** 报告中该接口被标记为不符合，并说明违反「URL 使用名词、避免动词」及建议（如改为资源路径 + GET）。
3. **Given** 某接口分页方式为路径或非标准参数，**When** 审计执行，**Then** 报告中标注是否符合「分页使用 page/size、排序使用 sort」及建议。

---

### User Story 2 - 按审计结果整改不符合项 (Priority: P2)

开发团队根据审计报告，对标记为不符合的接口进行整改：调整 URL 设计、HTTP 方法、请求/响应形态等，使接口满足《宪法》原则 6 的全部要求，且不破坏已有前端或调用方的兼容性（通过兼容策略或版本约定）。

**Why this priority**: 审计仅发现问题，整改才能达成「所有接口符合宪法」的目标。

**Independent Test**: 针对报告中的每一条不符合项，均有对应改动方案并实施后，再次审计全部通过。

**Acceptance Scenarios**:

1. **Given** 审计报告指出某接口 URL 含动词，**When** 开发按建议改为名词资源路径并选用合适 HTTP 方法，**Then** 该接口在复检中通过「URL 名词化、无动词」检查。
2. **Given** 某接口当前用 POST + body 做查询，**When** 改为 GET + page/size/sort 查询参数（或保留 POST 但文档说明理由），**Then** 符合「分页与排序」规则或在报告中以例外形式记录。
3. **Given** 整改涉及对外契约变更，**When** 团队完成接口变更，**Then** API 文档与调用方（或兼容层）已同步更新，无未记录的破坏性变更。

---

### User Story 3 - 将符合性纳入持续验证 (Priority: P3)

在完成首轮审计与整改后，将「原则 6」的检查纳入日常流程：例如在代码评审或 CI 中能自动或半自动地发现新增/修改接口是否仍符合 RESTful 规则，避免后续再出现不符合宪法的接口。

**Why this priority**: 一次性整改后若不持续约束，新接口容易再次偏离规范。

**Independent Test**: 新增一个故意违反原则 6 的接口（如 URL 含动词），通过既定流程能被发现并阻止或告警。

**Acceptance Scenarios**:

1. **Given** 已定义「原则 6」的检查规则，**When** 新增或修改接口，**Then** 存在可执行的检查步骤（人工清单或自动化），能判断该接口是否仍符合原则 6。
2. **Given** 检查发现新接口不符合，**When** 按流程处理，**Then** 不符合项在合入主分支前被纠正或经例外审批并记录。

---

### Edge Cases

- 若某模块（如认证登录）业界惯例使用 RPC 风格路径（如 `/login`、`/logout`），是否允许在文档中标注为「原则 6 例外」并说明理由，其余接口仍严格遵循？
- 若接口已对外稳定开放且调用方众多，整改会导致破坏性变更时，是否允许通过版本化（如 `/api/v2/...`）或兼容层逐步迁移，并在报告中标明「计划整改」与时间窗口？
- 审计范围是否包含通过 Gateway/代理暴露的第三方或遗留接口；若包含，其不符合项是否仅记录而不强制整改？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能对当前所有对外 HTTP 接口执行「原则 6：RESTful API 设计」的符合性检查，并产出结构化或可读的审计结果（通过/不通过及原因）。
- **FR-002**: 审计必须覆盖宪法 115–133 条中的每一条可检查项：HTTP 方法是否标准、URL 是否名词复数且无动词、状态码与 JSON/Result 包装、分页/排序参数、以及版本控制方式（若已采用）。
- **FR-003**: 对每个不符合项，必须能给出明确的问题描述与可操作的整改建议（例如：将 `/getUser` 改为 `GET /users/{id}`），便于开发执行。
- **FR-004**: 整改后的接口必须满足原则 6 的全部要求；若有合理例外（如登录/登出路径），必须在文档或审计报告中以例外形式记录并说明理由。
- **FR-005**: 接口变更（URL、方法、参数或响应形态）必须同步反映到 API 文档，并明确标注 HTTP 方法与状态码，满足宪法「验证」条款对文档的要求。
- **FR-006**: 在首轮审计与整改完成后，必须建立可持续的符合性验证机制（如评审检查清单或自动化规则），使新增或修改接口在合入前能再次接受原则 6 的检查。

### Key Entities

- **接口定义**：对外暴露的 HTTP 端点，包含 URL 路径、HTTP 方法、请求/响应形态；审计与整改的客体。
- **审计报告**：按接口与按规则维度的符合性结果，包含通过/不通过、不符合原因及建议。
- **原则 6 规则集**：宪法 115–133 条中可操作化的检查项（名词化 URL、标准方法、状态码、Result 包装、分页/排序、版本控制等）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 所有当前对外 HTTP 接口均已完成至少一次原则 6 的符合性审计，且审计结果以报告形式可查阅。
- **SC-002**: 审计报告中标记为不符合的接口，在项目约定时间内完成整改或已记录为受控例外，且复检通过率 100%（不含已批准例外）。
- **SC-003**: 新接口或接口变更在合入主分支前，均经过原则 6 的检查（人工或自动），且不符合项在合入前被处理或经例外审批。
- **SC-004**: API 文档与当前接口实现一致，且每个接口均明确标注 HTTP 方法与主要状态码，满足宪法「验证」中对文档的要求。
